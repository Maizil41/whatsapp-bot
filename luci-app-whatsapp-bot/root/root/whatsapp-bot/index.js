const{makeWASocket,DisconnectReason,useMultiFileAuthState,downloadMediaMessage}=require('@whiskeysockets/baileys');const express=require('express');const bodyParser=require('body-parser');const qrcode=require('qrcode');const fs=require('fs');const path=require('path');const{db}=require('./db');const configPath='/etc/config/whatsapp-bot';const app=express();const PORT=3000;app.use(bodyParser.json());app.use(express.static(path.join(__dirname,'public')));function getConfigValue(optionName){try{const data=fs.readFileSync(configPath,'utf8');const lines=data.split('\n');for(let line of lines){line=line.trim();if(line.startsWith(`option ${optionName}`)){const value=line.split("'")[1];return value}}
return null}catch(err){return null}}
const adminNumber=getConfigValue('admin_number');const admin_number=`${adminNumber}@s.whatsapp.net`;let daftarPengguna=[];let pembelianPaket={};let sock;function updateDaftarPengguna(userId,updatedData){const query='UPDATE client SET username = ?, password = ?, whatsapp_number = ?, telegram_id = ?, balance = ? WHERE id = ?';db.query(query,[updatedData.username,updatedData.password,updatedData.whatsapp_number,updatedData.telegram_id,updatedData.balance,userId],(err)=>{if(err)throw err})}
function loadDaftarPengguna(){return new Promise((resolve,reject)=>{const query='SELECT * FROM client';db.query(query,(err,results)=>{if(err){reject(err)}else{daftarPengguna=results;resolve(results)}})})}
async function connectToWhatsApp(){const{state,saveCreds}=await useMultiFileAuthState('./auth_info');sock=makeWASocket({printQRInTerminal:!1,auth:state});sock.ev.on('connection.update',async(update)=>{const{connection,lastDisconnect,qr}=update;if(connection==='close'){const errorCode=lastDisconnect?.error?.output?.statusCode;const shouldReconnect=errorCode?errorCode!==DisconnectReason.loggedOut:!0;if(shouldReconnect){setTimeout(connectToWhatsApp,5000)}}else if(connection==='open'){await loadDaftarPengguna()}else if(qr){const qrCode=qr;const dirPath=path.join(__dirname,'public');if(!fs.existsSync(dirPath)){fs.mkdirSync(dirPath,{recursive:!0})}
qrcode.toFile(path.join(dirPath,'qr_code.png'),qrCode,{errorCorrectionLevel:'H'},function(err){if(err)throw err})}});sock.ev.on('creds.update',saveCreds);const sendMessageWithRetry=async(to,messageOptions,retries=5)=>{try{await sock.sendMessage(to+'@s.whatsapp.net',messageOptions);return!0}catch(error){if(error.message.includes("Connection Closed")){await connectToWhatsApp();if(!sock.isConnected()){throw new Error("Koneksi tidak berhasil setelah reconnect.")}
if(retries>0){await new Promise(resolve=>setTimeout(resolve,2000));return sendMessageWithRetry(to,messageOptions,retries-1)}else{return!1}}else{return!1}}};app.post('/send-message',async(req,res)=>{const{to,message}=req.body;if(!sock||sock.authState==='Disconnected'){await connectToWhatsApp();if(sock.authState==='Disconnected'){return res.status(500).send('Koneksi WhatsApp tidak tersedia, coba lagi nanti')}}
try{await sock.sendMessage(to+'@s.whatsapp.net',{text:message});res.send('Pesan terkirim!')}catch(error){res.status(500).send('Gagal mengirim pesan')}});app.get('/',(req,res)=>{res.send(`
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>WhatsApp</title><style>body{font-family:Arial,sans-serif;background-color:#e5ddd5;margin:0;padding:20px;display:flex;align-items:center;height:100vh;flex-direction:column;box-sizing:border-box}h1{text-align:center;color:#075e54;margin-bottom:20px}#messageForm{background-color:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px;max-width:400px;width:100%}label{font-weight:700;display:block;margin:10px 0 5px}input[type=text],textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:4px;margin-bottom:10px;box-sizing:border-box}textarea{resize:vertical}button{background-color:#075e54;color:#fff;border:none;border-radius:4px;padding:10px;width:100%;cursor:pointer;font-size:16px}button:hover{background-color:#0b8b6d}</style></head><body><h1>Kirim Pesan WhatsApp</h1><form id="messageForm"><label for="to">Nomor Tujuan:</label><input type="text" id="to" name="to" required placeholder="Contoh: 6281234567890"><label for="message">Pesan:</label><textarea id="message" name="message" required></textarea><button type="submit">Kirim Pesan</button></form><script>document.getElementById('messageForm').onsubmit=async function(event){event.preventDefault();const to=document.getElementById('to').value;const message=document.getElementById('message').value;const response=await fetch('/send-message',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({to,message}),});const result=await response.text();alert(result);document.getElementById('message').value=''};</script></body></html>
        `)});app.get('/login',(req,res)=>{res.send(`
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>WhatsApp</title><style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:Arial,sans-serif;background-color:#d1d7db;display:flex;justify-content:center;align-items:center;min-height:100vh}.header{background-color:#00bfa5;padding:20px;color:#fff;text-align:left;width:100%;display:flex;align-items:center;justify-content:space-between}.header h1{margin-left:20px;font-size:24px}.content{background-color:#fff;border-radius:8px;padding:30px;box-shadow:0 4px 20px rgba(0,0,0,.1);max-width:900px;width:100%;display:flex;justify-content:space-between;align-items:flex-start}.instructions{max-width:45%;counter-reset:item}.instructions h2{color:#525252;font-size:24px;margin-bottom:15px}.instructions ol{list-style:none;padding-left:0}.instructions ol li{font-size:16px;color:#525252;margin-bottom:10px}.instructions ol li::before{content:counter(item) ". ";counter-increment:item;font-weight:700;color:#00bfa5}.warning{font-size:15px;color:red;margin:20px 0}.qr-code{display:flex;justify-content:center;align-items:center;width:45%;position:relative}.qr-code img{width:100%;max-width:300px;border-radius:10px}.qr-code-placeholder{background-color:#f0f0f0;width:100%;max-width:300px;height:300px;display:flex;justify-content:center;align-items:center;border-radius:10px}.qr-code-placeholder p{font-size:18px;color:#bfbfbf}.button-download{background-color:#00bfa5;color:#fff;border:none;padding:10px 20px;font-size:16px;cursor:pointer;border-radius:5px}.button-download:hover{background-color:#007c68}@media (max-width:768px){.content{flex-direction:column;align-items:flex-start}.instructions,.qr-code{width:100%;max-width:100%}.qr-code{margin-top:20px;justify-content:flex-start}}</style></head><body><section class="content"><div class="instructions"><h2>Petunjuk Cara Penggunaan</h2><ol id="link-device-phone-number-code-screen-instructions" class="x3yw8vx xgif2c7 xdj266r x11i5rnm xat24cr x1mh8g0r xbbxn1n"><li>Buka WhatsApp di ponsel Anda</li><li>Ketuk <strong>Menu<span><svg height="16px" viewBox="0 0 24 24" width="24px"><rect fill="#F2F2F2" width="24" height="24" rx="3"></rect><path d="m12 15.5c.825 0 1.5.675 1.5 1.5s-.675 1.5-1.5 1.5-1.5-.675-1.5-1.5.675-1.5 1.5-1.5zm0-2c-.825 0-1.5-.675-1.5-1.5s.675-1.5 1.5-1.5 1.5.675 1.5 1.5-.675 1.5-1.5 1.5zm0-5c-.825 0-1.5-.675-1.5-1.5s.675-1.5 1.5-1.5 1.5.675 1.5 1.5-.675 1.5-1.5 1.5z" fill="#818b90"></path></svg></span></strong>atau <strong class="x1rg5ohu xk50ysn x1o2sk6j">Pengaturan<span><svg width="16" height="16" viewBox="0 0 24 24"><rect fill="#F2F2F2" width="24" height="24" rx="3"></rect><path d="M12 18.69c-1.08 0-2.1-.25-2.99-.71L11.43 14c.24.06.4.08.56.08.92 0 1.67-.59 1.99-1.59h4.62c-.26 3.49-3.05 6.2-6.6 6.2zm-1.04-6.67c0-.57.48-1.02 1.03-1.02.57 0 1.05.45 1.05 1.02 0 .57-.47 1.03-1.05 1.03-.54.01-1.03-.46-1.03-1.03zM5.4 12c0-2.29 1.08-4.28 2.78-5.49l2.39 4.08c-.42.42-.64.91-.64 1.44 0 .52.21 1 .65 1.44l-2.44 4C6.47 16.26 5.4 14.27 5.4 12zm8.57-.49c-.33-.97-1.08-1.54-1.99-1.54-.16 0-.32.02-.57.08L9.04 5.99c.89-.44 1.89-.69 2.96-.69 3.56 0 6.36 2.72 6.59 6.21h-4.62zM12 19.8c.22 0 .42-.02.65-.04l.44.84c.08.18.25.27.47.24.21-.03.33-.17.36-.38l.14-.93c.41-.11.82-.27 1.21-.44l.69.61c.15.15.33.17.54.07.17-.1.24-.27.2-.48l-.2-.92c.35-.24.69-.52.99-.82l.86.36c.2.08.37.05.53-.14.14-.15.15-.34.03-.52l-.5-.8c.25-.35.45-.73.63-1.12l.95.05c.21.01.37-.09.44-.29.07-.2.01-.38-.16-.51l-.73-.58c.1-.4.19-.83.22-1.27l.89-.28c.2-.07.31-.22.31-.43s-.11-.35-.31-.42l-.89-.28c-.03-.44-.12-.86-.22-1.27l.73-.59c.16-.12.22-.29.16-.5-.07-.2-.23-.31-.44-.29l-.95.04c-.18-.4-.39-.77-.63-1.12l.5-.8c.12-.17.1-.36-.03-.51-.16-.18-.33-.22-.53-.14l-.86.35c-.31-.3-.65-.58-.99-.82l.2-.91c.03-.22-.03-.4-.2-.49-.18-.1-.34-.09-.48.01l-.74.66c-.39-.18-.8-.32-1.21-.43l-.14-.93a.426.426 0 00-.36-.39c-.22-.03-.39.05-.47.22l-.44.84-.43-.02h-.22c-.22 0-.42.01-.65.03l-.44-.84c-.08-.17-.25-.25-.48-.22-.2.03-.33.17-.36.39l-.13.88c-.42.12-.83.26-1.22.44l-.69-.61c-.15-.15-.33-.17-.53-.06-.18.09-.24.26-.2.49l.2.91c-.36.24-.7.52-1 .82l-.86-.35c-.19-.09-.37-.05-.52.13-.14.15-.16.34-.04.51l.5.8c-.25.35-.45.72-.64 1.12l-.94-.04c-.21-.01-.37.1-.44.3-.07.2-.02.38.16.5l.73.59c-.1.41-.19.83-.22 1.27l-.89.29c-.21.07-.31.21-.31.42 0 .22.1.36.31.43l.89.28c.03.44.1.87.22 1.27l-.73.58c-.17.12-.22.31-.16.51.07.2.23.31.44.29l.94-.05c.18.39.39.77.63 1.12l-.5.8c-.12.18-.1.37.04.52.16.18.33.22.52.14l.86-.36c.3.31.64.58.99.82l-.2.92c-.04.22.03.39.2.49.2.1.38.08.54-.07l.69-.61c.39.17.8.33 1.21.44l.13.93c.03.21.16.35.37.39.22.03.39-.06.47-.24l.44-.84c.23.02.44.04.66.04z" fill="#818b90"></path></svg></span></strong></li><li>Ketuk <strong>Perangkat tertaut</strong></li><li>Ketuk <strong>Tautkan perangkat</strong></li><li><span>Scan kode QR yang muncul di layar</span></li></ol><h1 class="warning">Sebaiknya scan menggunakan aplikasi<br>whatsapp resmi, agar tidak anu</h1></div><div class="qr-code"><div class="qr-code-placeholder" id="qrCodePlaceholder"><img src="./loading.gif"></div><img id="qrCode" style="display:none" alt="QR Code"></div></section><script>async function fetchQRCode(){const qrCodeImage=document.getElementById('qrCode');const qrCodePlaceholder=document.getElementById('qrCodePlaceholder');try{const response=await fetch('/qr_code.png?'+new Date().getTime(),{method:'HEAD'});if(response.ok){qrCodeImage.src='/qr_code.png?'+new Date().getTime();qrCodeImage.style.display='block';qrCodePlaceholder.style.display='none'}else{qrCodeImage.style.display='none';qrCodePlaceholder.style.display='flex'}}catch(error){console.error('Error fetching QR code:',error);qrCodeImage.style.display='none';qrCodePlaceholder.style.display='flex'}}
fetchQRCode();setInterval(fetchQRCode,1000);</script></body></html>
        `)});sock.ev.on('messages.upsert',async(m)=>{const message=m.messages[0];const remoteJid=message?.key?.remoteJid;const fromMe=message?.key?.fromMe;const messageText=message?.message?.conversation||'';if(fromMe)return;const senderNumber=remoteJid.split('@')[0];const isAdmin=remoteJid===admin_number;const isRegistered=!isAdmin&&daftarPengguna.some(user=>user.whatsapp_number===senderNumber);if(!isRegistered&&!messageText.toLowerCase().startsWith('daftar')&&!isAdmin){await sock.sendMessage(remoteJid,{text:'*Anda belum terdaftar. Ketik Daftar untuk mendaftar.*'});return}
if(messageText.toLowerCase().startsWith('daftar')){await loadDaftarPengguna();const isRegistered=daftarPengguna.some(user=>user.whatsapp_number===senderNumber);if(isRegistered){await sock.sendMessage(remoteJid,{text:'*Anda sudah terdaftar.*\n*Ketik Menu untuk melihat daftar menu*'})}else{const nama=messageText.split(' ')[1];if(nama){const query=`
                        INSERT INTO client (username, password, whatsapp_number, telegram_id, balance) 
                        VALUES (?, ?, ?, ?, ?)`;const values=[nama,nama,senderNumber,'','0'];db.query(query,values,async(error)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan saat mendaftar. Silakan coba lagi.*'});return}
daftarPengguna.push({username:nama,password:nama,whatsapp_number:senderNumber,telegram_id:'',balance:'0'});await sock.sendMessage(remoteJid,{text:`*Anda berhasil didaftarkan!* \n*Ketik Menu untuk melihat daftar menu.*`});await sock.sendMessage(admin_number,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬ PELANGGAN BARU â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*NAMA : ${nama}*\n*NOMOR : ${senderNumber}.*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`})})}else{await sock.sendMessage(remoteJid,{text:'*Gunakan perintah Daftar <nama_anda>.*'})}}}else if(messageText.toLowerCase().startsWith('topup')){await loadDaftarPengguna();let amount=messageText.split(' ')[1];if(amount){amount=amount.replace(/^0+/,'').replace(/[.,]/g,'');if(!amount||isNaN(amount)){await sock.sendMessage(remoteJid,{text:'*Masukkan jumlah yang valid.*'});return}
amount=parseInt(amount,10);if(amount<10000){await sock.sendMessage(remoteJid,{text:'*Permintaan topup minimal adalah 10.000*'});return}else if(amount>100000){await sock.sendMessage(remoteJid,{text:'*Permintaan topup maksimal adalah 100.000*'});return}
const pengguna=daftarPengguna.find(user=>user.whatsapp_number===senderNumber);if(pengguna){const nama=pengguna.username;const uid=pengguna.id;const queryInsert=`
                INSERT INTO topup (user_id, username, amount, status) 
                VALUES (?, ?, ?, ?)`;const values=[uid,nama,amount,'Pending'];db.query(queryInsert,values,async(error)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan saat memproses topup Anda.*'});return}
const querySelect=`SELECT id FROM topup WHERE user_id = ? AND status = 'Pending' ORDER BY date DESC LIMIT 1`;db.query(querySelect,[uid],async(error,rows)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan saat mengambil ID topup.*'});return}
const topupId=rows[0]?.id;if(!topupId){await sock.sendMessage(remoteJid,{text:'*ID topup tidak ditemukan.*'});return}
await sock.sendMessage(admin_number,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬   PERMINTAAN TOPUP  â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*NAMA : ${nama}*\n*NOMOR : ${senderNumber}*\n*JUMLAH : Rp.${amount}*\n*TOPUP ID : ${topupId}*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`});await sock.sendMessage(remoteJid,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬   TOPUP INVOICE  â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*# LAKUKAN PEMBAYARAN KE #*\n\n*â€¢DANA : ${adminNumber}*\n*â€¢OVO    : ${adminNumber}*\n\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*JIKA SUDAH MELAKUKAN*\n*PEMBAYARAN KIRIMKAN BUKTI*\n*TRANSFER KESINI*\n\n*BATAS WAKTU PEMBAYARAN*\n*SAMPAI 1 JAM KEDEPAN*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*NAMA : ${nama}*\n*NOMOR : ${senderNumber}*\n*JUMLAH : Rp.${amount}*\n*TOPUP ID : ${topupId}*\n*STATUS : PENDING*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`})})})}else{await sock.sendMessage(remoteJid,{text:'*Data anda tidak ditemukan. Pastikan Anda sudah terdaftar.*'})}}else{await sock.sendMessage(remoteJid,{text:'*Gunakan perintah Topup <jumlah>.*'})}}else if(messageText.toLowerCase().startsWith('saldo')){await loadDaftarPengguna();if(isAdmin){let allSaldo='â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬ DAFTAR PELANGGAN â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬';daftarPengguna.forEach(user=>{allSaldo+=`\n*NAMA : ${user.username}*\n*NOMOR : ${user.whatsapp_number}*\n*SALDO : Rp.${user.balance}*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`});await sock.sendMessage(remoteJid,{text:allSaldo})}else{const pengguna=daftarPengguna.find(user=>user.whatsapp_number===senderNumber);if(pengguna){await sock.sendMessage(remoteJid,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬ INFORMASI SALDO â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*NAMA : ${pengguna.username}*\n*NOMOR : ${pengguna.whatsapp_number}*\n*SALDO : Rp.${pengguna.balance}*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`})}else{await sock.sendMessage(remoteJid,{text:'*Data saldo anda tidak ditemukan.*'})}}}else if(messageText.toLowerCase().startsWith('menu')){await loadDaftarPengguna();const isAdmin=remoteJid===admin_number;if(isAdmin){await sock.sendMessage(remoteJid,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬ DAFTAR MENU ADMIN â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n\n*â€¢Accept - Konfirmasi topup*\n*â€¢Reject - Tolak topup*\n*â€¢Pending - List permintaan topup*\n*â€¢Saldo - List saldo pengguna*\n\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`})}else{await sock.sendMessage(remoteJid,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n *â–¬â–¬â–¬   DAFTAR MENU   â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n\n*â€¢Topup - Isi ulang saldo*\n*â€¢Beli - Beli voucher*\n*â€¢Saldo - Melihat sisa saldo*\n\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`})}}else if(messageText.toLowerCase().startsWith('beli')){await loadDaftarPengguna();const args=messageText.split(' ');if(args.length===1){db.query(`
            SELECT DISTINCT groups.groupname, billing_plans.planCost, billing_plans.planCode 
            FROM (
                SELECT groupname FROM radgroupcheck 
                UNION 
                SELECT groupname FROM radgroupreply
            ) AS groups 
            JOIN billing_plans ON groups.groupname = billing_plans.planName 
            WHERE billing_plans.planCode IS NOT NULL AND billing_plans.planCost > 0`,async(error,results)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan saat mengambil data paket. Silakan coba lagi.*'});return}
let paketList=results.map(row=>`*Paket: ${row.groupname}*\n*Harga: ${row.planCost}*\n*Kode: ${row.planCode}*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`).join('\n');await sock.sendMessage(remoteJid,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬   DAFTAR PAKET  â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n${paketList}\n\n*Ketik Beli <Kode_Paket>*`});pembelianPaket[senderNumber]=!0})}else{const paketPilihan=args[1];if(!pembelianPaket[senderNumber]){await sock.sendMessage(remoteJid,{text:'*Silakan ketik Beli untuk melihat daftar paket.*'});return}
db.query(`
            SELECT DISTINCT groups.groupname, billing_plans.planCost, billing_plans.planCode 
            FROM (
                SELECT groupname FROM radgroupcheck 
                UNION 
                SELECT groupname FROM radgroupreply
            ) AS groups 
            JOIN billing_plans ON groups.groupname = billing_plans.planName 
            WHERE billing_plans.planCode IS NOT NULL AND billing_plans.planCost > 0`,async(error,results)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan sistem saat mengambil data paket.*\n*Silahkan ulangi lagi.*'});return}
const paketData=results.find(row=>row.planCode.toLowerCase()===paketPilihan.toLowerCase());if(!paketData){await sock.sendMessage(remoteJid,{text:`*Tidak ada paket dengan kode [${paketPilihan}]*\n*Ketik Beli untuk melihat daftar paket*.`});return}
const hargaPaket=paketData.planCost;const pengguna=daftarPengguna.find(user=>user.whatsapp_number===senderNumber);if(!pengguna){await sock.sendMessage(remoteJid,{text:'*Data Anda tidak ditemukan.*\n*Pastikan Anda sudah terdaftar.*\n*Jika belum ketik Daftar <Nama>*'});return}
const namaPaket=paketData.groupname;if(parseInt(pengguna.balance)<hargaPaket){await sock.sendMessage(remoteJid,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬â–¬ BELI VOUCHER â–¬â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*Saldo anda tidak cukup untuk*\n*membeli paket*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*Nama Paket : ${namaPaket}*\n*Kode Paket : ${paketPilihan}*\n*Harga Paket : Rp.${hargaPaket}*\n*Saldo Anda  : Rp.${pengguna.balance}*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*Silahkan pilih paket lain atau isi*\n*ulang saldo anda*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`});return}
pengguna.balance=(parseInt(pengguna.balance)-hargaPaket).toString();const updatedData={username:pengguna.username,password:pengguna.password,whatsapp_number:pengguna.whatsapp_number,telegram_id:pengguna.telegram_id,balance:pengguna.balance};updateDaftarPengguna(pengguna.id,updatedData);function getCurrentTime(){const now=new Date();const year=now.getFullYear();const month=String(now.getMonth()+1).padStart(2,'0');const day=String(now.getDate()).padStart(2,'0');const hours=String(now.getHours()).padStart(2,'0');const minutes=String(now.getMinutes()).padStart(2,'0');const seconds=String(now.getSeconds()).padStart(2,'0');return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`}
const generateCode=(length=6)=>{const chars='123456789ABCDEFGHIJKLMNPQRSTUVWXYZ';let result='';for(let i=0;i<length;i++){const randomIndex=Math.floor(Math.random()*chars.length);result+=chars[randomIndex]}
return result};const code=generateCode();db.query("INSERT INTO radcheck (username, attribute, op, value) VALUES (?, ?, ?, ?)",[code,"Auth-Type",":=","Accept"],async(err)=>{if(err){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan sistem saat proses pembelian.*\n*Silahkan ulangi lagi.*'});return}
db.query("INSERT INTO radusergroup (username, groupname, priority) VALUES (?, ?, ?)",[code,paketData.groupname,0],(err)=>{if(err){return}});const username=code;const firstname=pengguna.username;const lastname='';const email='';const department='';const company='';const workphone='';const homephone='';const mobilephone=senderNumber;const address='';const city='';const state='';const country='';const zip='';const notes='';const changeuserinfo='0';const portalloginpassword='';const creationdate=getCurrentTime();const creationby=pengguna.username;db.query("INSERT INTO userinfo (username, firstname, lastname, email, department, company, workphone, homephone, mobilephone, address, city, state, country, zip, notes, changeuserinfo, portalloginpassword, creationdate, creationby) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[username,firstname,lastname,email,department,company,workphone,homephone,mobilephone,address,city,state,country,zip,notes,changeuserinfo,portalloginpassword,creationdate,creationby],(err)=>{if(err){return}});const planName=paketData.groupname;const contactperson=pengguna.username;const phone=senderNumber;const paymentmethod='cash';const cash=hargaPaket;const creditcardname='';const creditcardnumber='';const creditcardverification='';const creditcardtype='';const creditcardexp='';const changeuserbillinfo='0';const lead='';const coupon='';const ordertaker='';const billstatus='active';const nextinvoicedue='0';const billdue='0';const postalinvoice='';const faxinvoice='';const emailinvoice='';db.query("INSERT INTO userbillinfo (username, planName, contactperson, company, email, phone, address, city, state, country, zip, paymentmethod, cash, creditcardname, creditcardnumber, creditcardverification, creditcardtype, creditcardexp, notes, changeuserbillinfo, lead, coupon, ordertaker, billstatus, nextinvoicedue, billdue, postalinvoice, faxinvoice, emailinvoice, creationdate, creationby) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[username,planName,contactperson,company,email,phone,address,city,state,country,zip,paymentmethod,cash,creditcardname,creditcardnumber,creditcardverification,creditcardtype,creditcardexp,notes,changeuserbillinfo,lead,coupon,ordertaker,billstatus,nextinvoicedue,billdue,postalinvoice,faxinvoice,emailinvoice,creationdate,creationby],(err)=>{if(err){return}});await sock.sendMessage(remoteJid,{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬ VOUCHER INVOICE â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*Paket : ${paketData.groupname}*\n*Harga : Rp.${hargaPaket}*\n*Sisa Saldo : Rp.${pengguna.balance}*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬â–¬â–¬  ${code}  â–¬â–¬â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`})})})}}else if(isAdmin){if(messageText.toLowerCase().startsWith('accept')){await loadDaftarPengguna();const args=messageText.split(' ');if(args.length===2){const id=args[1];db.query(`SELECT user_id, username, amount FROM topup WHERE id = ? AND status = 'Pending'`,[id],async(error,results)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan saat mengambil data paket. Silahkan coba lagi.*'});return}
if(results.length>0){const{username,amount}=results[0];db.query(`UPDATE topup SET status = 'Accept' WHERE id = ? AND status = 'Pending'`,[id],async(updateError)=>{if(updateError){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan sistem saat memperbarui status.*\n*Silahkan coba lagi.*'});return}
const penggunaExist=daftarPengguna.find(user=>user.username===username);if(penggunaExist){penggunaExist.balance=(parseInt(penggunaExist.balance)+amount);await sock.sendMessage(remoteJid,{text:`*ðŸ’° Permintaan topup Rp.${amount} dari ${username} telah disetujui.*`});const nomorPengguna=penggunaExist.whatsapp_number;await sock.sendMessage(nomorPengguna+'@s.whatsapp.net',{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬   TOPUP INVOICE  â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*NAMA : ${username}*\n*NOMOR : ${nomorPengguna}*\n*JUMLAH : Rp.${amount}*\n*TOPUP ID : ${id}*\n*STATUS : SUKSES*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`});const updatedData={username:penggunaExist.username,password:penggunaExist.password,whatsapp_number:penggunaExist.whatsapp_number,telegram_id:penggunaExist.telegram_id,balance:penggunaExist.balance};updateDaftarPengguna(penggunaExist.id,updatedData)}else{await sock.sendMessage(remoteJid,{text:'*Pengguna tidak ditemukan.*'})}})}else{await sock.sendMessage(remoteJid,{text:'*Data tidak ditemukan.*'})}})}else{await sock.sendMessage(remoteJid,{text:'*Format perintah salah. Gunakan: Accept <TOPUP_ID>*'})}}else if(messageText.toLowerCase().startsWith('reject')){await loadDaftarPengguna();const args=messageText.split(' ');if(args.length===2){const id=args[1];db.query(`SELECT user_id, username, amount FROM topup WHERE id = ? AND status = 'Pending'`,[id],async(error,results)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan sistem saat mengambil data paket.*\n*Silakhan coba lagi.*'});return}
if(results.length>0){const{username,amount}=results[0];db.query(`UPDATE topup SET status = 'Reject' WHERE id = ? AND status = 'Pending'`,[id],async(updateError)=>{if(updateError){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan sistem saat memperbarui status.*\n*Silahkan coba lagi.*'});return}
const penggunaExist=daftarPengguna.find(user=>user.username===username);if(penggunaExist){penggunaExist.balance=(parseInt(penggunaExist.balance)+amount);await sock.sendMessage(remoteJid,{text:`*ðŸ’° Permintaan topup Rp.${amount} dari ${username} tidak disetujui.*`});const nomorPengguna=penggunaExist.whatsapp_number;await sock.sendMessage(nomorPengguna+'@s.whatsapp.net',{text:`â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬   TOPUP INVOICE  â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*NAMA : ${username}*\n*NOMOR : ${nomorPengguna}*\n*JUMLAH : Rp.${amount}*\n*TOPUP ID : ${id}*\n*STATUS : GAGAL*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`})}else{await sock.sendMessage(remoteJid,{text:'*Data tidak ditemukan.*'})}})}else{await sock.sendMessage(remoteJid,{text:'*Data tidak ditemukan.*'})}})}else{await sock.sendMessage(remoteJid,{text:'*Format perintah salah. Gunakan: Reject <TOPUP_ID>*'})}}else if(messageText.toLowerCase()==='pending'){await loadDaftarPengguna();db.query(`SELECT id, user_id, username, amount FROM topup WHERE status = 'Pending'`,async(error,results)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan sistem saat mengambil data Topup.*\n*Silakan coba lagi.*'});return}
if(results.length>0){let responseMessage='â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬\n*â–¬â–¬â–¬  TOPUP  PENDING  â–¬â–¬â–¬*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬';results.forEach(result=>{responseMessage+=`\n*NAMA : ${result.username}*\n*JUMLAH : Rp.${result.amount}*\n*TOPUP ID : ${result.id}*\nâ–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬`});await sock.sendMessage(remoteJid,{text:responseMessage})}else{await sock.sendMessage(remoteJid,{text:'*Tidak ada permintaan Topup saat ini.*'})}})}else if(messageText.toLowerCase()==='kipas on'){const{exec}=require('child_process');exec('/usr/bin/fan_control.sh on',async(error,stdout,stderr)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan saat menyalakan kipas.*'});return}
await sock.sendMessage(remoteJid,{text:'*Kipas berhasil dinyalakan.*'})})}else if(messageText.toLowerCase()==='kipas off'){const{exec}=require('child_process');exec('/usr/bin/fan_control.sh off',async(error,stdout,stderr)=>{if(error){await sock.sendMessage(remoteJid,{text:'*Terjadi kesalahan saat mematikan kipas.*'});return}
await sock.sendMessage(remoteJid,{text:'*Kipas berhasil dimatikan.*'})})}}else if(message?.message?.imageMessage){const buffer=await downloadMediaMessage(message,'buffer');const dirPath=path.join(__dirname,'bukti_transfer',senderNumber);const filePath=path.join(dirPath,`${Date.now()}.jpg`);if(!fs.existsSync(dirPath)){fs.mkdirSync(dirPath,{recursive:!0})}
fs.writeFileSync(filePath,buffer);await sock.sendMessage(admin_number,{text:`Bukti transfer diterima dari ${senderNumber}.`,image:{url:filePath}});await sock.sendMessage(remoteJid,{text:'*Bukti transfer Anda telah diterima dan menunggu konfirmasi dari admin.*'})}else{await sock.sendMessage(remoteJid,{text:'*Perintah tidak tersedia.*\n*Ketik Menu untuk melihat daftar perintah.*'})}})}
connectToWhatsApp();app.listen(PORT,()=>{})